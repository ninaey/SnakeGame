<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Pro ‚Äî Store Edition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0f12;
            --surface: #1a1a20;
            --surface2: #24242c;
            --border: #2e2e38;
            --text: #e8e8ed;
            --textDim: #8888a0;
            --accent: #00d4aa;
            --accentHover: #00f0c0;
            --danger: #ff4757;
            --gold: #ffc107;
            --success: #2ed573;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow-x: hidden;
        }
        .screen { display: none; flex-direction: column; align-items: center; gap: 1.5rem; padding: 2rem; max-width: 480px; }
        .screen.active { display: flex; }

        /* Menu */
        .logo {
            font-size: 2.5rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            background: linear-gradient(135deg, var(--accent), #00a080);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }
        .subtitle { color: var(--textDim); font-size: 0.95rem; margin-bottom: 2rem; }
        .btn {
            width: 100%;
            max-width: 280px;
            padding: 1rem 1.5rem;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, var(--accent), #00a080); color: var(--bg); }
        .btn-primary:hover { box-shadow: 0 6px 24px rgba(0, 212, 170, 0.35); }
        .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); }
        .menu-btns { display: flex; flex-direction: column; gap: 0.75rem; align-items: center; }
        .high-score { color: var(--textDim); font-size: 0.9rem; margin-top: 1rem; }
        .high-score span { color: var(--accent); font-weight: 600; }

        /* Game */
        .game-hud {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 400px;
            padding: 0.5rem 0;
        }
        .hud-item { display: flex; align-items: center; gap: 0.5rem; font-weight: 600; }
        .hud-item .icon { font-size: 1.2rem; }
        .game-wrap {
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            border: 2px solid var(--border);
        }
        #game { display: block; width: 400px; height: 400px; background: #0a0a0c; }
        .game-actions { display: flex; gap: 0.75rem; width: 100%; max-width: 400px; }
        .game-actions .btn { flex: 1; }

        /* Pause overlay */
        .pause-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.75);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            border-radius: 14px;
        }
        .pause-overlay.visible { display: flex; }
        .pause-overlay h3 { font-size: 1.5rem; }

        /* Game Over */
        .game-over-title { font-size: 1.75rem; color: var(--danger); margin-bottom: 0.25rem; }
        .game-over-score { font-size: 1.25rem; color: var(--textDim); }
        .game-over-score strong { color: var(--accent); }
        .game-over-actions { display: flex; flex-direction: column; gap: 0.75rem; width: 100%; max-width: 280px; margin-top: 0.5rem; }

        /* Store */
        .store-header { display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 0.5rem; }
        .store-title { font-size: 1.5rem; font-weight: 800; }
        .coins-badge {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            background: var(--surface2);
            padding: 0.5rem 0.9rem;
            border-radius: 999px;
            font-weight: 600;
            color: var(--gold);
        }
        .store-section { font-size: 0.85rem; color: var(--textDim); text-transform: uppercase; letter-spacing: 0.08em; margin: 1.25rem 0 0.5rem; width: 100%; max-width: 320px; }
        .store-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; width: 100%; max-width: 320px; }
        .store-card {
            background: var(--surface2);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .store-card.owned { border-color: var(--success); }
        .store-card.equipped { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }
        .store-card .preview { width: 64px; height: 64px; margin: 0 auto 0.75rem; border-radius: 10px; }
        .store-card .name { font-weight: 600; margin-bottom: 0.25rem; }
        .store-card .price { font-size: 0.9rem; color: var(--gold); margin-bottom: 0.75rem; }
        .store-card .price.free { color: var(--textDim); }
        .store-card button { width: 100%; padding: 0.5rem; font-size: 0.9rem; border-radius: 8px; font-family: inherit; font-weight: 600; cursor: pointer; border: none; background: var(--accent); color: var(--bg); }
        .store-card button:disabled { opacity: 0.6; cursor: not-allowed; }
        .store-card button.secondary { background: var(--surface); color: var(--text); border: 1px solid var(--border); }
        .store-back { margin-top: 1rem; }

        .cart-list { width: 100%; max-width: 320px; margin: 0.5rem 0; }
        .cart-item { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); font-size: 0.9rem; }
        .cart-item-info { flex: 1; min-width: 80px; }
        .cart-item-price { color: var(--gold); font-weight: 600; }
        .cart-item-qty { display: flex; align-items: center; gap: 0.25rem; }
        .qty-btn { width: 28px; height: 28px; padding: 0; font-size: 1rem; line-height: 1; border-radius: 6px; border: 1px solid var(--border); background: var(--surface2); color: var(--text); cursor: pointer; font-family: inherit; }
        .qty-btn:hover { background: var(--border); }
        .qty-num { min-width: 1.5rem; text-align: center; }
        .cart-item-remove { padding: 0.25rem 0.5rem; font-size: 0.8rem; border-radius: 6px; border: 1px solid var(--danger); background: transparent; color: var(--danger); cursor: pointer; font-family: inherit; }
        .cart-item-remove:hover { background: var(--danger); color: var(--bg); }
        .cart-total { font-weight: 600; margin: 0.5rem 0; }
        #btnCheckout { margin-top: 0.5rem; }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--surface2);
            border: 1px solid var(--border);
            padding: 0.75rem 1.25rem;
            border-radius: 10px;
            font-size: 0.95rem;
            opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
            z-index: 100;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
    </style>
</head>
<body>

    <!-- MENU -->
    <div id="menu" class="screen active">
        <div class="logo">Snake Pro</div>
        <p class="subtitle">Store Edition ‚Äî Eat, grow, and customize.</p>
        <div class="menu-btns">
            <button class="btn btn-primary" id="btnPlay">Play</button>
            <button class="btn btn-secondary" id="btnStore">Store</button>
        </div>
        <p class="high-score">Best score: <span id="highScore">0</span></p>
    </div>

    <!-- GAME -->
    <div id="gameScreen" class="screen">
        <div class="game-hud">
            <div class="hud-item"><span class="icon">‚≠ê</span> <span id="score">0</span></div>
            <div class="hud-item"><span class="icon">‚ù§Ô∏è</span> <span id="lives">3</span></div>
            <div class="hud-item"><span class="icon">‚ö°</span> <span id="speedDisplay">150</span>ms</div>
        </div>
        <div class="game-wrap">
            <canvas id="game" width="400" height="400"></canvas>
            <div id="pauseOverlay" class="pause-overlay">
                <h3>Paused</h3>
                <button class="btn btn-primary" id="btnResume">Resume</button>
            </div>
        </div>
        <div class="game-actions">
            <button class="btn btn-secondary" id="btnPause">Pause</button>
            <button class="btn btn-secondary" id="btnStoreInGame">Store</button>
        </div>
    </div>

    <!-- GAME OVER -->
    <div id="gameOverScreen" class="screen">
        <h2 class="game-over-title">Game Over</h2>
        <p class="game-over-score">Score: <strong id="finalScore">0</strong></p>
        <p class="game-over-score" id="coinsEarnedLine">Coins earned: <strong id="coinsEarned">0</strong></p>
        <div class="game-over-actions">
            <button class="btn btn-primary" id="btnBuyLife">Buy extra life (50 coins)</button>
            <button class="btn btn-primary" id="btnRetry">Try again</button>
            <button class="btn btn-secondary" id="btnMenuFromGameOver">Menu</button>
            <button class="btn btn-secondary" id="btnStoreFromGameOver">Store</button>
        </div>
    </div>

    <!-- STORE -->
    <div id="storeScreen" class="screen">
        <div class="store-header">
            <span class="store-title">Store</span>
            <div class="coins-badge">ü™ô <span id="storeCoins">0</span></div>
        </div>
        <p class="store-section">Lives</p>
        <div class="store-grid" id="storeLives"></div>
        <p class="store-section">Skins</p>
        <div class="store-grid" id="storeSkins"></div>
        <p class="store-section">Cart <span id="cartCount">(0)</span></p>
        <div id="cartList" class="cart-list"></div>
        <p class="cart-total">Total: <span id="cartTotal">0</span> ü™ô</p>
        <button class="btn btn-primary" id="btnCheckout" disabled>Create order</button>
        <button class="btn btn-secondary store-back" id="btnStoreBack">Back</button>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // ‚îÄ‚îÄ‚îÄ Globals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        const API = { base: '' };

        let state = {
            screen: 'menu',
            score: 0,
            lives: 3,
            extraLives: 0,
            speed: 150,
            snake: [],
            food: { x: 0, y: 0 },
            direction: null,
            nextDirection: null,
            gameLoop: null,
            paused: false,
            balance: 0,
            ownedSkins: ['default'],
            equippedSkin: 'default',
            highScore: parseInt(localStorage.getItem('snakeHighScore') || '0', 10)
        };

        const skins = {
            default:      { name: 'Default', price: 0,   head: '#2ed573', body: '#27ae60', eye: '#1a1a20' },
            skin_gold:    { name: 'Gold',    price: 100,  head: '#ffd700', body: '#daa520', eye: '#1a1a20' },
            skin_rainbow: { name: 'Rainbow', price: 100,  head: '#ff6b9d', body: '#c44dff', eye: '#1a1a20', gradient: true },
            skin_ice:     { name: 'Ice',     price: 100,  head: '#87ceeb', body: '#b0e0e6', eye: '#1a1a20' },
            skin_fire:    { name: 'Fire',    price: 100,  head: '#ff6b35', body: '#f7931e', eye: '#1a1a20' }
        };

        // ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const el = document.getElementById(id);
            if (el) el.classList.add('active');
            state.screen = id;
        }

        function toast(message, type = '') {
            const t = document.getElementById('toast');
            t.textContent = message;
            t.className = 'toast show ' + type;
            clearTimeout(toast._id);
            toast._id = setTimeout(() => t.classList.remove('show'), 2500);
        }

        function getSkin(id) {
            return skins[id] || skins.default;
        }

        // ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function apiGet(path) {
            const r = await fetch(API.base + path);
            return r.json();
        }

        async function apiPost(path, body) {
            const r = await fetch(API.base + path, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            return r.json();
        }

        async function apiPatch(path, body) {
            const r = await fetch(API.base + path, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await r.json().catch(() => ({}));
            if (!r.ok) { const e = new Error(data.error || 'Request failed'); e.json = data; throw e; }
            return data;
        }

        async function apiDelete(path) {
            const r = await fetch(API.base + path, { method: 'DELETE' });
            const data = await r.json().catch(() => ({}));
            if (!r.ok) { const e = new Error(data.error || 'Request failed'); e.json = data; throw e; }
            return data;
        }

        async function loadPlayer() {
            try {
                const p = await apiGet('/api/player');
                state.balance      = p.Balance      ?? 0;
                state.ownedSkins   = p.OwnedSkins   || ['default'];
                state.equippedSkin = p.EquippedSkin || 'default';
            } catch (e) {
                state.balance      = 0;
                state.ownedSkins   = ['default'];
                state.equippedSkin = 'default';
            }
        }

        // ‚îÄ‚îÄ‚îÄ Button handlers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        document.getElementById('btnPlay').onclick = () => { loadPlayer(); startGame(); };

        document.getElementById('btnStore').onclick = async () => {
            await loadPlayer();
            if (typeof renderStore === 'function') renderStore();
            showScreen('storeScreen');
        };

        document.getElementById('btnStoreInGame').onclick = async () => {
            state.paused = true;
            document.getElementById('pauseOverlay').classList.add('visible');
            await loadPlayer();
            if (typeof renderStore === 'function') renderStore();
            showScreen('storeScreen');
        };

        document.getElementById('btnStoreBack').onclick = () => {
            if (state.gameLoop) {
                showScreen('gameScreen');
                state.paused = false;
                document.getElementById('pauseOverlay').classList.remove('visible');
            } else {
                showScreen('menu');
            }
        };

        document.getElementById('btnResume').onclick = () => togglePause();
        document.getElementById('btnPause').onclick  = () => togglePause();

        document.getElementById('btnRetry').onclick = () => { loadPlayer(); startGame(); };

        document.getElementById('btnMenuFromGameOver').onclick = () => showScreen('menu');

        document.getElementById('btnStoreFromGameOver').onclick = async () => {
            await loadPlayer();
            if (typeof renderStore === 'function') renderStore();
            showScreen('storeScreen');
        };

        document.getElementById('btnBuyLife').onclick = async () => {
            if (state.balance < 50) { toast('Not enough coins', 'error'); return; }
            try {
                await apiPost('/api/user/cart/items', { itemId: 'extra_life' });
                const res = await apiPost('/api/user/orders', {});
                if (res.Status === 'Success') {
                    state.balance    = res.Balance    ?? state.balance;
                    state.extraLives = Math.max(0, Number(res.ExtraLives) || 0);
                    toast('Extra life purchased! Continue with 1 life.', 'success');
                    loadPlayer();
                    document.getElementById('btnBuyLife').style.display = 'none';
                    startGame(1);
                } else {
                    toast(res.Message || 'Purchase failed', 'error');
                }
            } catch (e) {
                toast('Network error', 'error');
            }
        };

        // Init high score display
        document.getElementById('highScore').textContent = state.highScore;
    </script>

    <script src="js/game.js"></script>
    <script src="js/store.js"></script>
</body>
</html>